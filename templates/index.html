<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente Acadêmico Inteligente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <h1>UniHelp</h1>
            <p>Assistente inteligente</p>
        </header>

        <div class="chat-messages" id="chat-messages">
            {% if not historico %}
            <div class="message assistant-message">
                <div class="message-content">
                    <p>Olá! Como posso ajudar?</p>
                </div>
            </div>
            {% endif %}

            {% for mensagem in historico %}
                <div class="message {{ 'user-message' if mensagem.role == 'user' else 'assistant-message' }}">
                    <div class="message-content">
                        {{ mensagem.content | safe }}
                    </div>
                </div>
            {% endfor %}
        </div>

        <footer class="chat-input-area">
            <form id="chat-form" method="POST" action="{{ url_for('chat') }}">
                <input type="text" id="pergunta" name="pergunta" placeholder="Digite sua pergunta..." autocomplete="off" required>
                <button type="submit" aria-label="Enviar Pergunta">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </button>
            </form>
            <button id="clear-chat" title="Limpar conversa">Limpar</button>
        </footer>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('pergunta');
        const clearBtn = document.getElementById('clear-chat');

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function createMessage(content, sender = 'assistant') {
            const message = document.createElement('div');
            message.classList.add('message', `${sender}-message`);

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');

            // Se for mensagem do usuário, usa <p>, se for da IA, insere HTML diretamente
            if (sender === 'user') {
                messageContent.innerHTML = `<p>${content}</p>`;
            } else {
                messageContent.innerHTML = content;
            }

            message.appendChild(messageContent);
            chatMessages.appendChild(message);
            scrollToBottom();
            return message;
        }

        function showLoading() {
            const loading = document.createElement('div');
            loading.classList.add('message', 'assistant-message');
            loading.id = 'loading-message';
            loading.innerHTML = `
                <div class="message-content">
                    <div class="loading-dots">
                        <span>.</span><span>.</span><span>.</span>
                    </div>
                </div>`;
            chatMessages.appendChild(loading);
            scrollToBottom();
        }

        function removeLoading() {
            const loading = document.getElementById('loading-message');
            if (loading) loading.remove();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pergunta = input.value.trim();
            if (!pergunta) return;

            createMessage(pergunta, 'user');
            input.value = '';
            showLoading();

            try {
                const response = await fetch('{{ url_for("chat") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ pergunta })
                });

                const html = await response.text();
                removeLoading();

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const lastAssistantMsg = tempDiv.querySelector('.assistant-message:last-child .message-content');

                if (lastAssistantMsg) {
                    createMessage(lastAssistantMsg.innerHTML, 'assistant');
                }
            } catch (error) {
                removeLoading();
                createMessage('❌ Erro ao se comunicar com o servidor.', 'assistant');
                console.error(error);
            }
        });

        clearBtn.addEventListener('click', () => {
            fetch('/limpar', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        chatMessages.innerHTML = `
                            <div class="message assistant-message">
                                <div class="message-content"><p>Conversa limpa. Como posso ajudar?</p></div>
                            </div>`;
                        scrollToBottom();
                    }
                });
        });

        scrollToBottom();
    </script>
</body>
</html>